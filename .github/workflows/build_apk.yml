name: Build Android APK (No Cache)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. ğŸ” çœŸç›¸éªŒè¯ç¯èŠ‚ (æ–°å¢)
      # è¿™ä¸€æ­¥ä¼šæŠŠ main.py çš„å†…å®¹æ‰“å°åˆ°æ—¥å¿—é‡Œã€‚
      # å¦‚æœæ—¥å¿—é‡Œæ˜¯æ–°ä»£ç ï¼Œé‚£ç»å¯¹ä¸å¯èƒ½æ‰“å‡ºæ—§åŒ…ã€‚
      - name: Check Main.py Content
        run: |
          echo "Listing all files:"
          ls -R
          echo "--------------------------------"
          echo "Reading main.py (First 20 lines):"
          cat main.py | head -n 20
          echo "--------------------------------"
          echo "Checking if views.py exists:"
          ls -l views.py

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 2. å®‰è£… uv (âŒ æ³¨æ„ï¼šæˆ‘æŠŠ cache å…³æ‰äº†)
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: false  # <--- å¼ºåˆ¶å…³é—­ç¼“å­˜ï¼Œé˜²æ­¢å®ƒå·æ‡’ç”¨æ—§æ–‡ä»¶

      # 3. å¼ºåˆ¶é‡æ–°å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          uv sync --reinstall  # <--- å¼ºåˆ¶é‡è£…ï¼Œä¸ç•™ä»»ä½•æ—§ç—•è¿¹

      # 4. æ¸…ç†æ—§æ„å»ºåƒåœ¾ (é˜²æ­¢ Flet ç¼“å­˜)
      - name: Clean Build Cache
        run: |
          rm -rf build/
          rm -rf dist/

      # 5. æ‰“åŒ… APK
      - name: Build APK
        run: |
          # åŠ ä¸Š --verbose çœ‹è¯¦ç»†æ—¥å¿—
          uv run flet build apk --verbose --project "Gonggong App"
        
      # 6. ä¸Šä¼ ç»“æœ
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-fresh
          path: "**/*.apk"